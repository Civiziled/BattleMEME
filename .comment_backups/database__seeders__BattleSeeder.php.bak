<?php

namespace Database\Seeders;

use App\Models\Battle;
use App\Models\Meme;
use App\Models\User;
use App\Models\Vote;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Storage;

class BattleSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // Créer un utilisateur de test
        $user = User::create([
            'name' => 'Admin Test',
            'email' => 'admin@test.com',
            'password' => bcrypt('password'),
            'email_verified_at' => now(),
        ]);

        // Créer quelques battles
        $battles = [
            [
                'title' => 'Battle des Mèmes de Chat les Plus Drôles',
                'description' => 'Montrez-nous vos meilleurs mèmes de chat ! Le plus drôle gagne. Les mèmes doivent être originaux et faire rire.',
                'deadline' => now()->addDays(7),
                'user_id' => $user->id,
            ],
            [
                'title' => 'Concours de Mèmes de Programmation',
                'description' => 'Les développeurs vont adorer cette battle ! Partagez vos mèmes sur la programmation, les bugs, et la vie de dev.',
                'deadline' => now()->addDays(5),
                'user_id' => $user->id,
            ],
            [
                'title' => 'Battle des Mèmes de Cuisine',
                'description' => 'Cuisine ratée, recettes bizarres, ou moments culinaires épiques ? Partagez vos mèmes de cuisine les plus hilarants !',
                'deadline' => now()->addDays(3),
                'user_id' => $user->id,
            ],
            [
                'title' => 'Mèmes de Voyage et Aventures',
                'description' => 'Voyages qui tournent mal, découvertes surprenantes, ou moments de tourisme parfait ? Montrez-nous vos mèmes de voyage !',
                'deadline' => now()->subDays(1), // Battle fermée
                'user_id' => $user->id,
            ],
        ];

        foreach ($battles as $battleData) {
            $battle = Battle::create($battleData);

            // Créer quelques mèmes pour chaque battle (sauf la fermée)
            if ($battle->isOpen()) {
                $this->createMemesForBattle($battle, $user);
            }
        }
    }

    private function createMemesForBattle(Battle $battle, User $user)
    {
        // Créer des utilisateurs supplémentaires pour les mèmes
        $users = collect([
            ['name' => 'MemeMaster', 'email' => 'meme1@test.com'],
            ['name' => 'CatLover', 'email' => 'meme2@test.com'],
            ['name' => 'DevHumor', 'email' => 'meme3@test.com'],
            ['name' => 'ChefFail', 'email' => 'meme4@test.com'],
        ])->map(function ($userData) {
            return User::firstOrCreate(
                ['email' => $userData['email']],
                [
                    'name' => $userData['name'],
                    'password' => bcrypt('password'),
                    'email_verified_at' => now(),
                ]
            );
        });

        // Créer des mèmes fictifs (sans vraies images pour l'instant)
        $memes = [
            [
                'image_path' => 'memes/placeholder1.jpg',
                'user_id' => $users[0]->id,
            ],
            [
                'image_path' => 'memes/placeholder2.jpg',
                'user_id' => $users[1]->id,
            ],
            [
                'image_path' => 'memes/placeholder3.jpg',
                'user_id' => $users[2]->id,
            ],
        ];

        foreach ($memes as $memeData) {
            $meme = Meme::create([
                'image_path' => $memeData['image_path'],
                'battle_id' => $battle->id,
                'user_id' => $memeData['user_id'],
            ]);

            // Créer quelques votes aléatoires
            $this->createVotesForMeme($meme, $users);
        }
    }

    private function createVotesForMeme(Meme $meme, $users)
    {
        // Chaque mème reçoit entre 0 et 3 votes aléatoires
        $voteCount = rand(0, min(3, $users->count() - 1)); // -1 pour exclure le créateur du mème
        $voters = $users->random($voteCount);

        foreach ($voters as $voter) {
            // Un utilisateur ne peut pas voter pour son propre mème
            if ($voter->id !== $meme->user_id) {
                Vote::create([
                    'user_id' => $voter->id,
                    'meme_id' => $meme->id,
                ]);
            }
        }
    }
}
